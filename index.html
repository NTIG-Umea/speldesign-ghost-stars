<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>TDS - test</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
      body {
        margin: 0;
      }
    </style>
  </head>

  <body>
    <script type="text/javascript">
      var config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        physics: {
          default: "arcade",
          arcade: {},
        },
        scene: {
          preload: preload,
          create: create,
          update: update,
        },
      };

      var player;
      var keys;
      var pointer;
      var playerSpeed = 3;

      /* GUNS
       * 0: Pistol
       * 1: SMG
       * 2: Shotgun
       */
      var weaponActive = 0;

      var weapon = [];

      var weaponCooldown = 0;
      var weaponSwitchCooldown = 0;
      var projectileSpeed = 12;
      var projectiles;
      var particles;

      var grenades;
      var grenadeCooldown = 0;
      var grenade;

      //World and Walls
      var worldSize = 16 * 64;
      var tileSize = 64;
      var walls;
      var wallPos = {
        x: [2, 3, 4, 7, 8, 8, 8, 8, 8, 8, 8, 8],
        y: [8, 8, 8, 8, 8, 1, 2, 3, 4, 5, 6, 7],
      };

      const game = new Phaser.Game(config);

      function preload() {
        this.load.spritesheet("player", "assets/playerSanta.png", {
          frameWidth: 78,
          frameHeight: 96,
        });
        this.load.image("projectile", "assets/star.png");
        this.load.image("wall", "assets/wall.png");
        this.load.image("floor", "assets/floor.png");
        this.load.image("particle", "assets/trail.png");
        this.load.image("grenade", "assets/star.png");
        this.load.image("pistol", "assets/pistol.png");
        this.load.image("uzi", "assets/uzi.png");
        this.load.image("shotgun", "assets/shotgun.png");
      }

      function create() {
        //Camera
        this.cameras.main.setBounds(0, 0, worldSize, worldSize);
        floor = this.physics.add.staticGroup();
        walls = this.physics.add.staticGroup();

        //Create floor tiles ovewr the whole map
        for (i = 0; i < Math.pow(worldSize / tileSize, 2); i++) {
          floor.create(
            tileSize / 2 +
              (i - Math.floor(i / (worldSize / tileSize)) * (worldSize / tileSize)) *
                tileSize,
            tileSize / 2 + Math.floor(i / (worldSize / tileSize)) * tileSize,
            "floor"
          );
        }

        //Create boarder walls
        for (i = 0; i < worldSize / tileSize; i++) {
          walls.create(tileSize / 2, i * tileSize, "wall"); //Left
          walls.create(worldSize - tileSize / 2, i * tileSize, "wall"); //Right
          walls.create(i * tileSize, tileSize / 2, "wall"); //Up
          walls.create(i * tileSize, worldSize - tileSize / 2, "wall"); //Down
        }

        //Create walls
        for (i = 0; i < wallPos.x.length; i++) {
          walls.create(
            wallPos.x[i] * tileSize - tileSize / 2,
            wallPos.y[i] * tileSize - tileSize / 2,
            "wall"
          );
        }

        //Player stuff
        player = this.physics.add.sprite(128, 128, "player");
        pointer = this.input.activePointer;
        this.physics.add.collider(player, walls);

        //Weapon sprites
        let newLength = weapon.push(
          (pistol = new Weapon("pistol", 35, 5, 60, -2.5, 15, 1)),
          (uzi = new Weapon("uzi", 30, 5, 62, -6, 3, 1)),
          (shotgun = new Weapon("shotgun", 15, 5, 54, 5, 30, 8))
        );

        pistolSprite = this.add.sprite(player.x, player.y, weapon[0].getSprite);
        uziSprite = this.add.sprite(player.x, player.y, weapon[1].getSprite);
        shotgunSprite = this.add.sprite(player.x, player.y, weapon[2].getSprite);

        pistolSprite.alpha = 0;
        uziSprite.alpha = 0;
        shotgunSprite.alpha = 0;

        //Projectile stuff
        projectiles = this.physics.add.group();

        // Grenade physics
        grenades = this.physics.add.group();
        this.physics.add.collider(grenades, walls);

        // creating a particle system using "particle" image
        particles = this.add.particles("particle");

        //Player animations, turning, walking left and walking right.
        this.anims.create({
          key: "down",
          frames: this.anims.generateFrameNumbers("player", {
            start: 0,
            end: 5,
          }),
          frameRate: 10,
          repeat: -1,
        });

        this.anims.create({
          key: "stop",
          frames: [{ key: "player", frame: 0 }],
          frameRate: 20,
        });

        this.anims.create({
          key: "up",
          frames: this.anims.generateFrameNumbers("player", {
            start: 6,
            end: 12,
          }),
          frameRate: 10,
          repeat: -1,
        });

        //Destroy projectiles when they hit walls
        this.physics.add.overlap(projectiles, walls, destroyProjectile, null, this);

        //Player WASD movement
        keys = this.input.keyboard.addKeys({
          up: Phaser.Input.Keyboard.KeyCodes.W,
          down: Phaser.Input.Keyboard.KeyCodes.S,
          left: Phaser.Input.Keyboard.KeyCodes.A,
          right: Phaser.Input.Keyboard.KeyCodes.D,
          grenade: Phaser.Input.Keyboard.KeyCodes.G,
          lastWeapon: Phaser.Input.Keyboard.KeyCodes.Q,
          nextWeapon: Phaser.Input.Keyboard.KeyCodes.E,
        });
      }

      function update(time, delta) {
        if (weaponCooldown > 0) {
          weaponCooldown--;
        }
        if (grenadeCooldown > 0) {
          grenadeCooldown--;
        }
        if (weaponSwitchCooldown > 0) {
          weaponSwitchCooldown--;
        }

        switch (weaponActive) {
          case 0:
            pistolSprite.x = player.x + weapon[0].getOffX;
            pistolSprite.y = player.y + weapon[0].getOffY;
            pistolSprite.alpha = 1;
            break;

          //SMG
          case 1:
            uziSprite.x = player.x + weapon[1].getOffX;
            uziSprite.y = player.y + weapon[1].getOffY;
            uziSprite.alpha = 1;
            break;

          //Shotgun
          case 2:
            shotgunSprite.x = player.x + weapon[2].getOffX;
            shotgunSprite.y = player.y + weapon[2].getOffX;
            shotgunSprite.alpha = 1;
            break;
        }

        if (
          (keys.lastWeapon.isDown || keys.nextWeapon.isDown) &&
          weaponSwitchCooldown === 0
        ) {
          if (keys.lastWeapon.isDown) {
            if (weaponActive == 0) {
              weaponActive = weapon.length - 1;
            } else {
              weaponActive--;
            }
          }
          if (keys.nextWeapon.isDown) {
            if (weaponActive == weapon.length - 1) {
              weaponActive = 0;
            } else {
              weaponActive++;
            }
          }
          pistolSprite.alpha = 0;
          uziSprite.alpha = 0;
          shotgunSprite.alpha = 0;
          weaponSwitchCooldown = 20;
        }

        //Camera
        var cam = this.cameras.main;

        /* Player movement
         *  the first variables decide the direction the player is moving.
         *  ex, if playerMovingX is -1 the player moves left, if its 1 they move right and if its 0 it stays in place.
         */
        let playerMovingX = 0;
        let playerMovingY = 0;

        //Checks if a specific direction is pressed, then adds or subracts from that direction by 1.
        if (keys.left.isDown) {
          playerMovingX += -1;
        }
        if (keys.right.isDown) {
          playerMovingX += 1;
        }
        if (keys.up.isDown) {
          playerMovingY += -1;
        }
        if (keys.down.isDown) {
          playerMovingY += 1;
        }

        if (playerMovingY === 1) {
          player.anims.play("down", true);
        } else if (playerMovingY === -1) {
          player.anims.play("up", true);
        } else {
          player.anims.play("stop", true);
        }

        /* Movement algoritm
         *  if the player is moving on both the X and Y axis then divide the movement algorithm by the square root of 2.
         *  This is done to prevent the player from moving faster on the hypotenuse.
         */
        if (!(playerMovingX === 0) && !(playerMovingY === 0)) {
          player.setVelocityX((playerMovingX * playerSpeed * 100) / Math.SQRT2);
          player.setVelocityY((playerMovingY * playerSpeed * 100) / Math.SQRT2);
        } else {
          player.setVelocityX(playerMovingX * playerSpeed * 100);
          player.setVelocityY(playerMovingY * playerSpeed * 100);
        }

        //Moves the camera to the players position
        this.cameras.main.centerOn(player.x, player.y);

        //if the mouse is clicked -> shoot
        if (pointer.isDown) {
          let angle = Phaser.Math.Angle.Between(
            player.x + weapon[weaponActive].getMuzX,
            player.y + weapon[weaponActive].getMuzY,
            pointer.x + this.cameras.main.worldView.x,
            pointer.y + this.cameras.main.worldView.y
          );

          let v = 100 * projectileSpeed;
          let uv = {
            x: Math.cos(angle),
            y: Math.sin(angle),
          };
          let vx = v * uv.x;
          let vy = v * uv.y;

          shoot(
            player.x + weapon[weaponActive].getMuzX,
            player.y + weapon[weaponActive].getMuzY,
            vx,
            vy,
            angle
          );
        }

        // G is pressed -> throw grenade
        if (keys.grenade.isDown) {
          let angle = Phaser.Math.Angle.Between(
            player.x,
            player.y,
            pointer.x + this.cameras.main.worldView.x,
            pointer.y + this.cameras.main.worldView.y
          );

          let v = 100 * projectileSpeed;
          let uv = {
            x: Math.cos(angle),
            y: Math.sin(angle),
          };
          let vx = v * uv.x;
          let vy = v * uv.y;

          throwGrenade(player.x, player.y, vx, vy);
        }
      }

      function shoot(x, y, vx, vy, angle) {
        if (weaponCooldown === 0) {
          for (var i = 0; i < weapon[weaponActive].getBulletMultiplier; i++) {
            createProjectile(x, y, vx, vy, angle, 8);
          }
          weaponCooldown = weapon[weaponActive].getCooldown;
        }
      }

      //Change how "spread" works in the future
      function createProjectile(x, y, vx, vy, angle, spread) {
        let projectile = projectiles.create(x, y, "projectile");
        projectile.setVelocityX(vx + spread * (Math.random() - 0.5) * 20);
        projectile.setVelocityY(vy + spread * (Math.random() - 0.5) * 20);

        //Trail emitter configuration
        projectile.emitter = particles.createEmitter({
          speed: 0,
          tint: Math.random() * 0xff0000 + 50,
          rotate: (angle * 180) / Math.PI,
          scale: {
            start: 1,
            end: 0,
          },
          alpha: {
            start: 0.5,
            end: 0,
          },
          // 1 = 1 milisecond
          frequency: 1,
          lifespan: 400,
          blendmode: "ADD",
        });

        // Create a emmiter on the projectile
        projectile.emitter.startFollow(projectile);
      }

      function destroyProjectile(projectile) {
        projectile.emitter.stop();
        projectile.destroy();
      }

      function throwGrenade(x, y, vx, vy) {
        if (grenadeCooldown === 0) {
          createGrenade(x, y, vx, vy, 0);
          grenadeCooldown = 70;
        }
      }

      // Create grenade
      function createGrenade(x, y, vx, vy) {
        grenade = grenades.create(x, y, "grenade");
        grenade.setVelocityX(vx * 0.5);
        grenade.setVelocityY(vy * 0.5);
        grenade.setBounce(0.3);
      }

      class Weapon {
        constructor(sprite, offX, offY, muzX, muzY, cd, bm) {
          this.sprite = sprite;
          this.offX = offX;
          this.offY = offY;
          this.muzX = muzX;
          this.muzY = muzY;
          this.cd = cd;
          this.bm = bm;
        }

        get getSprite() {
          return this.sprite;
        }
        get getOffX() {
          return this.offX;
        }
        get getOffY() {
          return this.offY;
        }
        get getMuzX() {
          return this.muzX;
        }
        get getMuzY() {
          return this.muzY;
        }
        get getCooldown() {
          return this.cd;
        }
        get getBulletMultiplier() {
          return this.bm;
        }
      }
    </script>
  </body>
</html>
