<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>TDS - test</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
      body {
        margin: 0;
      }
    </style>
  </head>

  <body>
    <script type="text/javascript">
      var config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        physics: {
          default: "arcade",
          arcade: {},
        },
        scene: {
          preload: preload,
          create: create,
          update: update,
        },
      };

      var player;
      var keys;
      var pointer;
      var playerSpeed = 3;

      /* GUNS
       * 0: Pistol
       * 1: SMG
       * 2: Shotgun
       */
      var weaponActive = 0;
      var weaponCooldown = 0;
      var projectileSpeed = 8;
      var projectiles;
      var particles;
      
      //World and Walls
      var worldSize = 512 * 4;
      var walls;

      const game = new Phaser.Game(config);

      function preload() {
        this.load.image('background', "assets/512pxbackground.png");
        this.load.spritesheet('player', 'assets/santa.png', { frameWidth: 78, frameHeight: 96 });
        this.load.image('projectile', "assets/star.png");
        this.load.image('ground', "assets/wall.png")
        this.load.image('particle', "assets/trail.png");
      }

      function create() {
        //Camera
        this.cameras.main.setBounds(0, 0, worldSize, worldSize);

        //background
        this.add.image(0, 0, "background").setOrigin(0);
        this.add.image(512, 0, "background").setOrigin(0);
        this.add.image(512, 512, "background").setOrigin(0);
        this.add.image(0, 512, "background").setOrigin(0);

        // Create walls  
        walls = this.physics.add.staticGroup();
        walls.create(512, 256, 'ground').refreshBody();
        walls.create(256, 0, 'ground');
        walls.create(768, 512, 'ground');

        //Player stuff
        player = this.physics.add.sprite(0, 0, "player");
        pointer = this.input.activePointer;

        this.physics.add.collider(player, walls);

        //Projectile stuff
        projectiles = this.physics.add.group();
        // creating a particle system uising "particle" image
        particles = this.add.particles("particle");
 
        //Player animations, turning, walking left and walking right.
    this.anims.create({
        key: 'down',
        frames: this.anims.generateFrameNumbers('player', { start: 0, end: 5 }),
        frameRate: 10,
        repeat: -1
    });

    this.anims.create({
        key: 'stop',
        frames: [ { key: 'player', frame: 0 } ],
        frameRate: 20
    });

    this.anims.create({
        key: 'up',
        frames: this.anims.generateFrameNumbers('player', { start: 6, end: 12 }),
        frameRate: 10,
        repeat: -1
    });

        //Destroy projectiles when they hit walls
        this.physics.add.overlap(projectiles, walls, destroyProjectile, null, this);

        //Player WASD movement
        keys = this.input.keyboard.addKeys({
          up: Phaser.Input.Keyboard.KeyCodes.W,
          down: Phaser.Input.Keyboard.KeyCodes.S,
          left: Phaser.Input.Keyboard.KeyCodes.A,
          right: Phaser.Input.Keyboard.KeyCodes.D,
        });
      }

      function shoot(x, y, vx, vy) {
        switch (weaponActive) {
          
          //Pistol
          case 0:
            if (weaponCooldown === 0) {
              createProjectile(x, y, vx, vy, 0);
              weaponCooldown = 20;
            }
            break;
          
          //SMG
          case 1:
            if (weaponCooldown === 0) {
              createProjectile(x, y, vx, vy, 4);
              weaponCooldown = 4;
            }
            break;
          
          //Shotgun
          case 2:
            if (weaponCooldown === 0) {
              for (var i = 0; i < 8; i++) {
                createProjectile(x, y, vx, vy, 8);
              }
              weaponCooldown = 40;
            }
            break;
        }
      }

      function update(time, delta) {
        if (weaponCooldown > 0) {
          weaponCooldown -= 1;
        }

        //Camera
        var cam = this.cameras.main;

        /* Player movement
         *  the first variables decide the direction the player is moving.
         *  ex, if playerMovingX is -1 the player moves left, if its 1 they move right and if its 0 it stays in place.
         */

        let playerMovingX = 0;
        let playerMovingY = 0;

        //Checks if a specific direction is pressed, then adds or subracts from that direction by 1.
        if (keys.left.isDown) {
          playerMovingX += -1;
        }
        if (keys.right.isDown) {
          playerMovingX += 1;
        }
        if (keys.up.isDown) {
          playerMovingY += -1;
          player.anims.play('up', true);
        }
        if (keys.down.isDown) {
          playerMovingY += 1;
          player.anims.play('down', true);
        }

        /* Movement algoritm
         *  if the player is moving on both the X and Y axis then divide the movement algorithm by the square root of 2.
         *  This is done to prevent the player from moving faster on the hypotenuse.
         */
        if (!(playerMovingX === 0) && !(playerMovingY === 0)) {
          player.setVelocityX((playerMovingX * playerSpeed * 100) / Math.SQRT2);
          player.setVelocityY((playerMovingY * playerSpeed * 100) / Math.SQRT2);
        } else {
          player.setVelocityX(playerMovingX * playerSpeed * 100);
          player.setVelocityY(playerMovingY * playerSpeed * 100);
        }

        //Moves the camero to the players position
        this.cameras.main.centerOn(player.x, player.y);

        //if the mouse is clicked -> shoot
        if (pointer.isDown) {
          let angle = Phaser.Math.Angle.Between(
            player.x,
            player.y,
            pointer.x + this.cameras.main.worldView.x,
            pointer.y + this.cameras.main.worldView.y
          );

          let v = 100 * projectileSpeed;
          let uv = {
            x: Math.cos(angle),
            y: Math.sin(angle),
          };
          let vx = v * uv.x;
          let vy = v * uv.y;

          shoot(player.x, player.y, vx, vy);
        }
      }
      /*
       * X: The x position where the projectile is created
       * Y: The y position where the projectile is created
       * vx: The projectiles speed on the x axis
       * vy: The projectiles speed on the y axis
       * spread: the amount of spread the weapon should have. (number is multiplied by 10)
       */
       function createProjectile(x, y, vx, vy, spread) {
        var projectile = projectiles.create(x, y, "projectile");
        projectile.setVelocityX(vx + spread * (Math.random() - 0.5) * 20);
        projectile.setVelocityY(vy + spread * (Math.random() - 0.5) * 20);

        // trail emitter configuration
        emitter = particles.createEmitter({
            speed: 0,
            tint: (Math.random() * 0xFFFFFF + 50),
            scale: {
                start: 1,
                end: 0
            },
            alpha: {
                start: 0.5,
                end: 0
            }, 
            // 1 = 1 milisecond
            frequency: 1,
            
            lifespan: 300
        });
        
        // Create a emmiter on the projectile
        emitter.startFollow(projectile);
      }
        
      function destroyProjectile(projectile) {
          projectile.destroy();
          emitter.stop();
      }
    </script>
  </body>
</html>
